# processing-service-core

NodeJS implementation of data-processing-service contract. Uses the swagger-node library to provide validation against a yaml contract for requests and responses.

## Overview

The data-processing-service is a NodeJS implementation of the swagger data-processing-service-contract. It implements those methods as calls to a Policy API instance, where a single call on the contract may be represented as multiple calls to the Policy API, creating structures that can be used for data processing by components that support the Policy API. This project aims to simplify the interactions required with the Core Policy API to create and manage the objects required for data processing.

## Pre-Requisites

An http contactable Core Policy API instance that this API may call.

## Detailed Overview

The data-processing-service is a NodeJS implementation of the swagger data-processing-service-contract. It implements many of those methods as calls to a Policy API instance, where a single call on the contract may be represented as multiple calls to the Policy API, creating structures that can be used for data processing by components that support the Policy API. This project aims to simplify the interactions required with the Core Policy API to create and manage the objects required for data processing. It also provides management of tenant configurations by communicating directly with a database.

A more detailed overview of the workflow operations is available [here](./Architecture.md).

A more detailed overview of the repository configuration options is available [here](./repository-config-options.md).

A more detailed overview of the tenant configuration options is available [here](./tenant-config-options.md).

A more detailed overview of how to use global configurations can be found [here](./global-config-options.md).

## Quick Start

### Run UI install

Execute the maven install goal on the [processing-service-ui](../processing-service-ui) project. This will copy a modified version of the swagger-ui containing the processing-service contract to the ui folder of this directory.

## Developer Quick Start
### Install using Source Code
For developers it is recommended to install and run the project with swagger-node directly. This is useful as when changes are made to files the server will be reloaded automatically.

1. Check out the project.
2. Install NodeJS and NPM (package manager for NodeJS). This project was written against NodeJS 8 and has not been tested with later versions so no assurances can be given regarding using the latest major version release of NodeJS.
3. Install swagger-node

    ```
    npm install -g swagger
    ```
    This will allow using various `swagger` commands from command line e.g. `swagger project start`.
4. From the project directory run the below command to install the dependencies via node package manager.

    ```
    npm install
    ```
5. Run the swagger project start command to launch the server.

    ```
    swagger project start
    ```    
    
### Editing Swagger Contract

The swagger CLI provides a browser based swagger editor that can be used to modify the contract.

```
swagger project edit
```
    
## UI

A  Swagger UI is available based on the UI generated in the data-processing-service-contract repository [here](https://github.com/CAFDataProcessing/data-processing-service/tree/develop/processing-service-contract).

The UI is generated by a Swagger library using the contract. The [processing-service-ui](../processing-service-ui) project will generate the UI and copy it to the correct location in the API folder structure. To generate the UI for a locally running service, run a maven install on the processing-service-ui project before starting the API.

For a deployed service the UI is available at;

```
http://<service.ip.address>:<port>/data-processing-ui
```

Replace <service.ip.address> and <port> as necessary.

## Configuration

Configuration is achieved via environment variables.

### General Service Configuration

#### CAF_PROCESSING_SERVICE_PORT
The port that the service will run on. Defaults to 8080.

#### CAF_PROCESSING_SERVICE_CACHE_DURATION
The time in seconds that cached data should be retained. Defaults to 600.

### Policy API Service Configuration

#### CAF_PROCESSING_SERVICE_POLICY_API_HOST
The host that the Policy API is deployed to. Defaults to localhost.

#### CAF_PROCESSING_SERVICE_POLICY_API_PORT
The port that the Policy API is running on. Defaults to 9000.

#### CAF_PROCESSING_SERVICE_POLICY_API_ENTRY_PATH
The url path that all calls to Policy API should start with. Defaults to '/corepolicy'.

### Database Configuration

Database connection details are required to allow management of global and tenant configurations.

#### CAF_PROCESSING_SERVICE_DATABASE_HOST

The host that the database can be contacted on. Defaults to 'localhost'.

#### CAF_PROCESSING_SERVICE_DATABASE_NAME

The name of the database containing global and tenant configuration tables. Defaults to 'workflow'.

#### CAF_PROCESSING_SERVICE_DATABASE_PASSWORD

The password to use to access the database. Defaults to an empty value.

#### CAF_PROCESSING_SERVICE_DATABASE_PORT

The port to contact database on. Defaults to 5432.

#### CAF_PROCESSING_SERVICE_DATABASE_USERNAME

The username to use to access the database. Defaults to 'root'.

### Logging Configuration

#### CAF_LOG_LEVEL
Controls the minimum level of log message that will be output by service.
- DEBUG: Lowest level, intended for diagnosing behaviour of the service.
- INFO: General messages that may be of interest about the operation of the service. This is the default level if none if not configured.
- WARNING: Occurrences in the service that may require attention but are not determined to be detrimental to operation of the service.
- ERROR: For problems that occur in the service that impede correct function.
